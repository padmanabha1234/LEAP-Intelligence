
<!DOCTYPE html>
<html>
<head>
   <title>OEE Dashboard</title>
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
   <!-- Bootstrap CSS -->
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
      <!-- Other headers -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
   <!-- Chart.js -->
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <!-- JQuery -->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
   <!-- Other headers -->
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

   <!-- CSS -->
   <!-- JS, Popper.js, and jQuery -->
   <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.bundle.min.js"></script>



   <style>

      .microphone-icon {
    width: 50px; /* Set the width of the microphone icon */
    height: 30px; /* Set the height of the microphone icon */
}


  /* Custom CSS Variables */
  .record-container {
            display: flex;
<!--            justify-content: center;-->
<!--            align-items: center;-->
            height: 14vh; /* Set the height of the container to full viewport height */
        }
        :root {
            --record-size: 3vw;
            --record-bg-color: #0dab05;
            --record-border-color: #2bc03c;
            --record-circle-color: #fff;
        }

        /* Record Button Styles */
        .record-button {
            width: var(--record-size);
            height: var(--record-size);
            border-radius: 50%;
            border: 6px solid var(--record-border-color);
            background-color: var(--record-bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform var(--record-animation-duration) ease-in-out;
        }

        .record-circle {
            width: calc(var(--record-size) * 0.6);
            height: calc(var(--record-size) * 0.6);
            border-radius: 50%;
            background-color: var(--record-circle-color);
            animation: pulse var(--record-animation-duration) infinite;
        }
         .record-button-container {
            display: flex;
            align-items: center;
            height: 100%; /* Fill the entire height of the parent container */
        }

      </style>
</head>
<style>
      .tab-pane.container,
      .container.tab-pane.fade {
      max-height: calc(100vh - 150px);
      overflow-y: auto;
      padding: 20px;
      }
      .nav.nav-tabs {
      margin-top: 20px;
      margin-left: 20px;
      margin-right: 20px;
      }
      .tab-pane.container {
      text-align: left;
      margin-left: 25px;
      }
      .modal-dialog {
      max-width: 40vw;
      margin: 0 auto;
      }
      .modal-footer {
      display: flex;
      justify-content: center;
      }
      .tab-content {
      margin-bottom: 20px;
      }
      #tab3,
      #tab4 {
      height: calc(100vh - 150px);
      }
      #oeeChart {
      max-height: 300px;
      width: auto;
      height: auto;
      }
      #incident {
      max-width: 400px;
      max-height: 400px;
      }
      .popup {
      position: absolute;
      top: calc(100% + 10px);
      left: 0;
      transform: translateX(-50%);
      background-color: white;
      padding: 20px;
      display: none;
      z-index: 9999;
      }
      #correlationChart {
      width: 100%; /* Adjust the width as needed */
      height: 400px; /* Adjust the height as needed */
      border: 1px solid #ccc; /* Add a border if desired */
      }
      #alerts-icon {
      position: fixed;
      right: 30px;
      top: 100px;
      border: 2px solid #000; /* Rectangle border */
      border-radius: 5px; /* Rounded corners */
      padding : 4px;
      cursor: pointer;
      }
      .badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      border-radius: 50%;
      background-color: red;
      color: white;
      }
      #notifications-list {
      position: fixed;
      right: 10px;
      top: 150px;
      width: 20%;
      height: 400px;
      border-radius: 10px;
      overflow-y: scroll;
      background-color: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      display: none;
      padding: 20px;
      z-index: 9999;
      }
      .button-container {
      display: flex;
      gap: 20px;
      }
      table {
      width: 100%;
      border-collapse: collapse;
      }
      th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      }
      th {
      background-color: #f2f2f2;
      }
      tr:hover {
      background-color: #f5f5f5;
      nav nav-tabs.{
      margin-top: 20px;
      }
      .card {
      border-radius: 10px; /* Rounded corners */
      background-color: blue;
      }
      .alerts {
      position: relative;
      }
      .alerts-icon {
      font-size: 12px;
      cursor: pointer;
      }
      .alerts-count {
      position: absolute;
      top: -10px;
      right: -10px;
      background: red;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 2rem;
      }
      .notifications-list {
      max-height: calc(100vh - 150px); /* Adjust the value according to your layout */
      overflow-y: auto;
      }
      .notification {
      margin-bottom: 5px;
      display: block;
      border-left: 4px solid #000; /* Thick left border */
      border-right: 2px solid #ccc; /* Shadow effect for right border */
      border-top: 2px solid #ccc; /* Shadow effect for top border */
      border-bottom: 2px solid #ccc; /* Shadow effect for bottom border */
      transition: border-color 0.3s;
      clear: both;
      padding-left: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      }
      .notification-text {
      display: inline-block;
      background-color: transparent;
      }
      .notification:not(.notification-flash) {
      background-color: white;
      border: 1px solid transparent;
      }
      .notification-icon {
      margin-right: 10px;
      }
      .notification-close {
      cursor: pointer;
      }
      /* Existing Styles */
      .notification {
      padding: 10px; /* Adjust padding as needed */
      margin: 10px; /* Adjust margin as needed */
      border-radius: 5px;
      border: 1px solid transparent; /* Initial border style */
      background-color: blue; /* Example background color */
      transition: border-color 0.3s ease; /* Smooth transition for border color */
      }
      .notification:hover {
      border-color: #ccc; /* Border color on hover */
      }
      .notification-icon {
      margin-right: 15px;
      color: #4e73df;
      }
      .notification-content {
      flex-grow: 1;
      }
      .notification-close {
      color: #aaaaaa;
      }
      .notification-close:hover {
      color: #000000;
      }
      .notification-flash {
      display: inline-block;
      white-space: nowrap;
      width: 20%;
      position: fixed;
      bottom: 10px;
      right: 10px;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
      transition: 0.3s;
      animation: slide-up 0.5s ease-out;
      }
      @keyframes slide-up {
      0% {
      bottom: -50px;
      opacity: 0;
      }
      100% {
      bottom: 10px;
      opacity: 1;
      }
      }
   </style>
   <body>
<!--  <div class="container">-->
<ul class="nav nav-tabs" style="margin-top:20px">

<!--<div class="">-->
   <li class="nav-item col-md-2 mt-2 d-flex mb-3">
                <label for="langSelect">&nbsp;</label>
                <select id="langSelect" class="form-control form-control-sm">
                    <option value="en">English</option>
                    <option value="hi">Hindi</option>
                    <option value="kn">Kannada</option>
                    <option value="ta">Tamil</option>
                    <option value="te">Telugu</option>
                </select>
            </div>
         </li>
   <li class="nav-item">
            <div class="col-md-2 mt-2">
                <div class="record-container">
                    <div class="record-button-container">
                        <div class="record-circle d-flex align-items-center justify-content-center">
                            <button id="startButton" class="record-button">
                                <img src="/static/mic.png" alt="Start Recording" class="microphone-icon">
                            </button>
                        </div>
                    </div>
                </div>
            </div>
   </li>
</ul>
        <!-- Rest of your content goes here -->
         <div id="audioOutput"></div>
         <div id="logOutput"></div>
    </div>

    <div id="result"></div>
      <!--      <div class="container">-->
      <!--Manual Alerts-->
      <div class="modal fade" id="incidentModal" tabindex="-1" role="dialog" aria-labelledby="incidentModalLabel" aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
               <div class="modal-header">
                  <h5 class="modal-title" id="incidentModalLabel">Incident</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                  </button>
               </div>
               <div class="modal-body">
                  <form>
                     <div class="form-group">
                        <label for="date-select">Date:</label>
                        <select id="date-select" class="form-control">
                           <!-- Options will be populated dynamically -->
                        </select>
                        <label for="machine-select">Machine:</label>
                        <select id="machine-select" class="form-control">
                           <!-- Options will be populated dynamically -->
                        </select>
                     </div>
                     <div class="form-group">
                        <label for="shift-select">Shift:</label>
                        <select id="shift-select" class="form-control">
                           <!-- Options will be populated dynamically -->
                        </select>
                        <label for="time-select">Time:</label>
                        <select id="time-select" class="form-control">
                           <!-- Options will be populated dynamically -->
                        </select>
                     </div>
                     <div class="form-group">
                        <label for="incident-select">Incident:</label>
                        <select id="incident-select" class="form-control">
                           <option>Machine Failure</option>
                           <option>Person Not available</option>
                           <option>Other</option>
                        </select>
                        <label for="description-text">Description:</label>
                        <textarea id="description-text" class="form-control" rows="3"></textarea>
                     </div>
                  </form>
               </div>
               <div class="modal-footer">
                  <button id="inc_submit" type="submit" class="btn btn-primary">Submit</button>
               </div>
            </div>
         </div>
      </div>

      <ul class="nav nav-tabs" style="margin-top:20px">
         <li class="nav-item">
            <a class="nav-link active" data-toggle="tab" href="#manual">Manual and Threshold</a>
         </li>
         <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#tab2">Correlation</a>
         </li>
         <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#tab3">Trend Analysis</a>
         </li>
         <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#tab4">Forecast</a>
         </li>

         <!--   <li class="nav-item">-->
         <!--      <a class="nav-link" data-toggle="tab" href="#tab5">Tab 5</a>-->
         <!--   </li>-->
         <div class="button-container ml-auto" style="margin-right:5rem;">
            <li class="nav-item">
               <button id="manual-alerts-button" class="btn btn-primary mx-2 btn-block" data-toggle="modal" data-target="#incidentModal">Manual Alerts</button>
            </li>
            <form action="/upload" method="post">
               <button id="manual-connect-btn" class="btn btn-primary mr-4 btn-block" data-toggle="modal" type="submit" style="background-color:green;color:white;">Connect</button>
            </form>
              <div id="alerts" class="alerts">
            <span id="alerts-icon">
            <i class="fa fa-bell fa-1x"></i>
            <span id="alerts-count" class="alerts-count"></span>
            </span>
            <div id="notifications-list" class="notifications-list"></div>
         </div>
         </div>
      </ul>
      </div>
      <div class="tab-content">
         <div id="manual" class="tab-pane container active">
            <div class="row">
               <div class="col-md-2">
                  <label for="machineSelect">Machine:</label>
                  <select id="machineSelect" class="form-control form-control-sm"  style="width: 150px;"style="width: 150px;">
                     <option value="">Select Machine</option>
                     <!-- Add options dynamically -->
                  </select>
               </div>
               <div class="col-md-2">
                  <label for="shiftSelect">Shift:&nbsp;</label>
                  <select id="shiftSelect" class="form-control form-control-sm">
                     <option value="">Select Shift</option>
                     <!-- Add options dynamically -->
                  </select>
               </div>
               <div class="col-md-2">
                  <label for="paramSelect">&nbsp;Parameter:</label>
                  <select id="paramSelect" class="form-control form-control-sm">
                     <option value="oee">OEE</option>
                     <option value="availability">Availability</option>
                     <option value="performance">Performance</option>
                     <option value="quality">Quality</option>
                  </select>
               </div>
               <div class="col-md-2" style="color:#495057">
                  <div class="form-group">
                     <label for="low">Lower Threshold:</label>
                     <input id="low" type="number" placeholder="Lower Threshold" class="form-control form-control-sm"  style="width: 150px;" value="50">
                  </div>
               </div>
               <div class="col-md-2" style="color:#495057">
                  <div class="form-group">
                     <label for="high">Upper Threshold:</label>
                     <input id="high" type="number" placeholder="Higher Threshold" class="form-control form-control-sm"  style="width: 150px;" value="70">
                  </div>
               </div>
            </div>
            <canvas id="oeeChart" width="300" height="400"></canvas>
         </div>
         <div id="tab2" class="container tab-pane fade">
            <canvas id="correlationChart" width="300" height="100"></canvas>
         </div>
         <div id="tab3" class="container tab-pane fade" style="color:#495057">
            <form id="trendForm">
               <div class="form-row align-items-center">
                  <div class="form-group col-md-2">
                     <label for="param">Parameter:</label>
                     <select id="param" name="param" class="form-control form-control-sm">
                        <option value="oee">OEE</option>
                        <option value="availability">Availability</option>
                        <option value="performance">Performance</option>
                        <option value="quality">Quality</option>
                     </select>
                  </div>
                  <div class="form-group col-md-2">
                     <label for="direction">Direction:</label>
                     <select id="direction" name="direction" class="form-control form-control-sm">
                        <option value="up">Up</option>
                        <option value="down">Down</option>
                     </select>
                  </div>
                  <div class="form-group col-md-2">
                     <label for="days">No. of Days:</label>
                     <input type="text" id="days" name="days" class="form-control form-control-sm">
                  </div>
                  <div class="form-group col-md-2">
                     <label for="rate">Rate:</label>
                     <input type="text" id="rate" name="rate" class="form-control form-control-sm">
                  </div>
                  <div class="form-group col-md-2">
                     <label for="submitBtn" class="invisible">Submit:</label>
                     <button type="submit" id="submitBtn" class="btn btn-primary btn-block">Submit</button>
                  </div>
               </div>
            </form>
            <div id="resultTable"></div>
         </div>
         <div id="tab4" class="container tab-pane fade" style="color:#495057">
            <!-- Dropdowns for Tab 4 -->
            <form action="/flask/forecasting" method="GET">
               <div class="form-row">
                  <div class="form-group col-md-2">
                     <label for="machineSelectTab4">Machine</label>
                     <select class="form-control form-control-sm" style="width: 150px;" id="machineSelectTab4" name="machine">
                        <!-- Dropdown options -->
                     </select>
                  </div>
                  <div class="form-group col-md-2">
                     <label for="shiftSelectTab4">Shift</label>
                     <select class="form-control form-control-sm"  style="width: 150px;" id="shiftSelectTab4" name="shift">
                        <!-- Dropdown options -->
                     </select>
                  </div>
                  <div class="form-group col-md-2">
                     <label for="paramSelectTab4">Parameter</label>
                     <select class="form-control form-control-sm"  style="width: 150px;" id="paramSelectTab4" name="parameter">
                        <option value="oee">OEE</option>
                        <option value="availability">Availability</option>
                        <option value="performance">Performance</option>
                        <option value="quality">Quality</option>
                     </select>
                  </div>
                  <div class="form-group col-md-1">
                     <label for="submitBtn" class="invisible">Submit</label>
                     <button type="submit" class="btn btn-primary btn-block">Submit</button>
                  </div>
               </div>
            </form>
            <canvas id="forecasting" width="400" height="150"></canvas>
         </div>
      </div>
<script !src="">
   $(document).ready(function() {
  $("#manual-alerts-button").click(function() {
    var notification = $("<div class='notification'></div>");
    var icon = $("<span class='notification-icon'><i class='fa fa-bell'></i></span>");
    var content = $("<span class='notification-content'>This is a professional notification.</span>");
    var close = $("<span class='notification-close'><i class='fa fa-times'></i></span>");

    close.click(function() {
      notification.remove();
    });

    notification.append(icon);
    notification.append(content);
    notification.append(close);

    $("#notifications-list").prepend(notification);
  });
});

let notifications = [];
let alertsCount = 0;
let visibleNotifications = 0;

const abbreviationMap = {
  "Higher Threshold": "HT",
  "Lower Threshold": "LT",
  "Higher Anomaly": "HA",
  "Lower Anomaly": "LA"
};

const colorMap = {
  "Higher Threshold": "#F1948A", // Muted red
  "Lower Threshold": "#F1948A", // Navy blue
  "Higher Anomaly": "#5DADE2", // Muted orange
  "Lower Anomaly": "#5DADE2" // Muted green
};

function addNotification(type, message) {
  alertsCount++;
  document.getElementById('alerts-count').innerText = alertsCount;

  const abbreviationMap = {
    "Higher Threshold": "HT",
    "Lower Threshold": "LT",
    "Higher Anomaly": "HA",
    "Lower Anomaly": "LA"
  };

  const colorMap = {
    "Higher Threshold": "#F1948A", // Muted red
    "Lower Threshold": "#F1948A", // Navy blue
    "Higher Anomaly": "#5DADE2", // Muted orange
    "Lower Anomaly": "#5DADE2" // Muted green
  };

  notifications.push({
    type: abbreviationMap[type],
    message: message,
    color: colorMap[type]
  });

  // Flash the notification for 2 seconds
  let notificationDiv = document.createElement('div');
  notificationDiv.className = 'notification-flash';

  let typeSpan = document.createElement('span');
  typeSpan.className = 'notification-type';
  typeSpan.innerText = `${abbreviationMap[type]}: `;
  typeSpan.style.fontWeight = 'bold';

  let messageSpan = document.createElement('span');
  messageSpan.className = 'notification-message';
  messageSpan.innerText = message;

  // Split the message into two parts: text before the date and text after the date
const parts = message.split(/(?<=\d{2}\/\d{2}\/\d{2})/);
const textBeforeDate = parts[0];
const textAfterDate = parts[1];

// Create separate spans for the text before and after the date
const textBeforeDateSpan = document.createElement('span');
textBeforeDateSpan.innerText = textBeforeDate;

const textAfterDateSpan = document.createElement('span');
textAfterDateSpan.innerText = textAfterDate;
textAfterDateSpan.style.fontStyle = 'italic'; // Make the text after the date italic
textAfterDateSpan.style.fontSize = "x-large";

  notificationDiv.appendChild(typeSpan);
  notificationDiv.appendChild(messageSpan);

  notificationDiv.style.backgroundColor = colorMap[type];
  notificationDiv.style.color = 'white';
  document.body.appendChild(notificationDiv);

  setTimeout(() => {
    document.body.removeChild(notificationDiv);
  }, 2000);
}

// CSS style for .notification-flash class
const flashStyle = document.createElement('style');
flashStyle.innerHTML = `
    .notification-flash {
        display: block;
        white-space: nowrap;
        padding: 5px 10px;
        margin: 5px;
        border-radius: 5px;
        width: 40%;
    }

    .notification {
        margin-bottom: 5px;
        display: block;
        border-left: 4px solid #000; /* Thick left border */
        border-right: 2px solid #ccc; /* Shadow effect for right border */
        border-top: 2px solid #ccc; /* Shadow effect for top border */
        border-bottom: 2px solid #ccc; /* Shadow effect for bottom border */
        transition: border-color 0.3s;
        clear: both;
        padding-left: 10px;
        position: relative;
        padding-left: 10px;
        overflow: hidden;
    }

    .notification-type {
        font-weight: bold;
    }

    .notification-message {
        margin-left: 5px;
    }

    .notification:hover {
        border-color: #000; /* Highlight the border on hover */
    }

    .notification:last-child {
        margin-bottom: 0;
    }
`;
document.head.appendChild(flashStyle);

function displayNotifications() {
  let notificationsList = document.getElementById('notifications-list');
  notificationsList.style.position = 'fixed';
  notificationsList.style.top = '10';
  notificationsList.style.right = '0';
  notificationsList.style.height = '100vh';

  notifications.forEach(notification => {
    let notificationDiv = document.createElement('div');
    notificationDiv.className = 'notification';

    let typeSpan = document.createElement('span');
    typeSpan.className = 'notification-type';
    typeSpan.innerText = `${notification.type}: `;

    let messageSpan = document.createElement('span');
    messageSpan.className = 'notification-message';
    messageSpan.innerText = notification.message;

    notificationDiv.appendChild(typeSpan);
    notificationDiv.appendChild(messageSpan);

    notificationDiv.style.backgroundColor = 'transparent'; // Set transparent background color
    notificationDiv.style.borderLeftColor = notification.color; // Set left border color
    notificationDiv.style.color = notification.color; // Set text color to match the border color
    notificationsList.appendChild(notificationDiv); // Use appendChild to add notifications in separate lines
  });

  // Toggle display of notifications list
  notificationsList.style.display = notificationsList.style.display === 'block' ? 'none' : 'block';
}

document.getElementById('alerts-icon').addEventListener('click', function() {
  let notificationsList = document.getElementById('notifications-list');
  displayNotifications();
  // If the notifications list is visible, reset alerts count and notifications
  if (notificationsList.style.display === 'block') {
    alertsCount = 0;
    document.getElementById('alerts-count').innerText = '';
    notifications = [];
  }
});
</script>
<script !src="">
           let stream;
        let mediaRecorder;
        let chunks = [];
        let sourceLanguage = 'en';
        let recordingInProgress = false;
        let recognition = "can you select machine, shift and parameter";
        let voice;

        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const audioOutput = document.getElementById('audioOutput');

        const langSelect = document.getElementById('langSelect');

        langSelect.addEventListener('change', () => {
  sourceLanguage = langSelect.value;
  target_lang_for_audio = langSelect.value;
  if (chunks.length > 0) {
    const audioBlob = new Blob(chunks, { type: 'audio/mpeg; codecs=opus' });
    chunks = [];
    const reader = new FileReader();
    reader.onloadend = () => {
      const base64String = reader.result.split(',')[1];
      fetchASRResult(base64String);
    };
    reader.readAsDataURL(audioBlob);
  }
});


        const handleSuccess = (stream) => {
            window.stream = stream;
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = (e) => {
                chunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(chunks, { type: 'audio/mpeg; codecs=opus' });
                chunks = [];

                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64String = reader.result.split(',')[1];
                    const audioElement = document.createElement('audio');
                    audioElement.src = 'data:audio/mpeg;base64,' + base64String;
                    audioElement.controls = true;
                    audioOutput.innerHTML = '';
                    // audioOutput.appendChild(audioElement);

                    // Call the function to fetch ASR result and display it
                    fetchASRResult(base64String);
                };

                reader.readAsDataURL(audioBlob);
            };
        };


startButton.addEventListener('click', async () => {
  if (!recordingInProgress) {
    // Start recording
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recordingInProgress = true;

    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = (e) => {
      chunks.push(e.data);
    };
    mediaRecorder.onstop = () => {
      const audioBlob = new Blob(chunks, { type: 'audio/mpeg; codecs=opus' });
      chunks = [];

      const reader = new FileReader();
      reader.onloadend = () => {
        const base64String = reader.result.split(',')[1];
        fetchASRResult(base64String);
      };

      reader.readAsDataURL(audioBlob);
    };

    mediaRecorder.start();
//    startButton.textContent = 'Stop Recording';
    startButton.style.backgroundColor = '#e74c3c';
    startButton.style.borderColor = '#c94f42';
    const microphoneIcon = startButton.querySelector('.microphone-icon');
    microphoneIcon.src = '/static/microphone_icon.png';

    // Automatically stop recording after 10 seconds
    setTimeout(() => {
      stopRecording();
    }, 5000); // 5 seconds in milliseconds
  }
});



function stopRecording() {
  if (recordingInProgress) {
    mediaRecorder.stop();
    stream.getTracks().forEach(track => track.stop());
    recordingInProgress = false;
        startButton.style.backgroundColor = '#0dab05';
    startButton.style.borderColor = '#2bc03c';
    const microphoneIcon = startButton.querySelector('.microphone-icon');
    microphoneIcon.src = '/static/mic.png';
  }
}


        async function fetchASRResult(base64Audio) {
            const url = 'https://dhruva-api.bhashini.gov.in/services/inference/pipeline';

            const compute_call_authorization_value = 'LJnB60OoLOll1nX_MpsGJdxLfAgoJAqWWA-d5n48g2O8rdQ3US3Klcrn9XM1ZfZG'
            const asr_service_id = 'ai4bharat/whisper-medium-en--gpu--t4';
            const target_language = 'en'
            const nmt_service_id = 'ai4bharat/indictrans-v2-all-gpu--t4'

            const requestBody = {
    pipelineTasks: [
        {
            taskType: 'asr',
            config: {
                language: {
                    sourceLanguage: sourceLanguage
                },
                serviceId: asr_service_id,
                audioFormat: 'flac',
                samplingRate: 16000
            }
        },
        {
            taskType: 'translation',
            config: {
                language: {
                    sourceLanguage: sourceLanguage,
                    targetLanguage: target_language
                },
                serviceId: nmt_service_id
            }
        }
    ],
    inputData: {
        audio: [
            {
                audioContent: base64Audio
            }
        ]
    }
};

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': compute_call_authorization_value
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                displayResult(data);
            } catch (error) {
                displayError('Error occurred while fetching ASR result.');
                console.error(error);
            }
        }

        const machineKeywords = ['machine', 'select machine'];
const shiftKeywords = ['shift', 'select shift'];
const parameterKeywords = ['parameter', 'select parameter', 'parameters', 'select parameters'];
const submitKeywords = ['submit', 'submit form', 'submit data'];


function displayResult(data) {
//    const resultDiv = document.getElementById('result');
//    resultDiv.textContent = JSON.stringify(data, null, 2);

    // Get the ASR result text from the response data
    const asrResultSource = data?.pipelineResponse?.[0]?.output?.[0]?.source;
    const asrResultTarget = data?.pipelineResponse?.[1]?.output?.[0]?.target;

    // Check for keywords in both source and target ASR result texts and select the corresponding tab
    if (asrResultSource || asrResultTarget) {
        const tab1Keywords = ['threshold'];
        const tab2Keywords = ['correlation'];
        const tab3Keywords = ['trend analysis'];
        const tab4Keywords = ['forecast'];
        const alertKeywords = ['alert'];
        const connectKeywords = ['connect'];


        const lowercaseSource = asrResultSource?.toLowerCase() || '';
        const lowercaseTarget = asrResultTarget?.toLowerCase() || '';

        const combinedResult = lowercaseSource + ' ' + lowercaseTarget;
        console.log('Data is presented', combinedResult);

        if (tab1Keywords.some(keyword => combinedResult.includes(keyword))) {
            activateTab('manual');
            text = "Please Select the options";
            var utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "en-IN";
            window.speechSynthesis.speak(utterance);
        } else if (tab2Keywords.some(keyword => combinedResult.includes(keyword))) {
            activateTab('tab2');
            text = "Here are the details";
            var utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "en-IN";
            window.speechSynthesis.speak(utterance);
        } else if (tab3Keywords.some(keyword => combinedResult.includes(keyword))) {
            activateTab('tab3');
            text = "Please Select the options";
            var utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "en-IN";
            window.speechSynthesis.speak(utterance);
        } else if (tab4Keywords.some(keyword => combinedResult.includes(keyword))) {
            activateTab('tab4');
            text = "Please Select the options";
            var utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "en-IN";
            window.speechSynthesis.speak(utterance);
        } else if (alertKeywords.some(keyword => combinedResult.includes(keyword))) {
            activateTab('manual-alerts-button', true); // Activate "Manual Alerts" button
            text = "Ok";
            var utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "en-IN";
            window.speechSynthesis.speak(utterance);
        } else if (connectKeywords.some(keyword => combinedResult.includes(keyword))) {
            activateTab('manual-connect-btn', true); // Activate "Connect" button
            text = "Ok";
            var utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "en-IN";
            window.speechSynthesis.speak(utterance);
        }
    }
}
displayResult({});

function activateTab(target, isButton = false) {
    if (!isButton) {
        // Handle tab activation
        const tabElement = document.getElementById(target);
        if (tabElement) {
            // Deactivate all tabs
            const tabContents = document.querySelectorAll('.tab-pane');
            tabContents.forEach(tab => tab.classList.remove('show', 'active'));

            // Deactivate all tab labels and remove the red color highlight
            const tabLabels = document.querySelectorAll('.nav-link');
            tabLabels.forEach(label => {
                label.classList.remove('active');
                label.style.backgroundColor = ''; // Remove inline style
                label.style.color = ''; // Remove inline style for text color
            });

            // Activate the selected tab
            tabElement.classList.add('show', 'active');

            // Find the corresponding tab label and add the 'active' class with red color highlight
            const tabLabel = findTabLabelForTab(target);
            if (tabLabel) {
                tabLabel.classList.add('active');
                tabLabel.style.backgroundColor = 'red'; // Apply red color highlight
                tabLabel.style.color = 'white';
            }
        }
    } else {
        // Handle button activation
        const buttonElement = document.getElementById(target);
        if (buttonElement) {
            buttonElement.click(); // Simulate a click on the button
        }
    }
}


function findTabLabelForTab(tabId) {
    // Find the corresponding tab label (anchor) for the given tabId
    const tabLabels = document.querySelectorAll('.nav-link');
    for (const tabLabel of tabLabels) {
        if (tabLabel.getAttribute('href') === `#${tabId}`) {
            return tabLabel;
        }
    }
    return null; // Return null if the tab label is not found
}


        function displayError(errorMessage) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = errorMessage;
        }

        function displayLog(message) {
    const logOutput = document.getElementById('logOutput');
    logOutput.textContent += message + '\n';
}
</script>
<script !src="">
   let chart = new Chart(document.getElementById('oeeChart'), {
  type: 'line',
  data: {
    labels: [],  // Initially, the chart has no data
    datasets: [{
      label: 'Time vs Parameter',
      data: [],
      fill: false,
      borderColor: 'rgb(75, 192, 192)',
      tension: 0.1
    }]
  },
  options: {
    scales: {
      x: {},
      y: {
        min: 0,
        max: 100,
      }
    }
  }
});

let an_low = 0;
let an_high = 100;

function updateChart() {
  let machine = $('#machineSelect').val();
  let shift = $('#shiftSelect').val();
  let param = $('#paramSelect').val();

  $.getJSON('/get_anomaly_values', {
    column: param
  }, function(data) {
    an_low = data.low;
    an_high = data.high;
    console.log(data);
  });

  console.log('Anomaly High ->', an_high);
  console.log('Anomaly Low ->', an_low);

  if (machine && shift) {
    $.getJSON('/get_oee_value', {
      machine: machine,
      shift: shift
    }, function(data) {
      console.log('Data ->', data);
      let time = data['time'];

      if (time != null) {
        console.log('Entering...');
        console.log('New time:', time);

        if (chart.data.labels.length > 20) {
          console.log('Removing first data point');
          chart.data.labels.shift(); // remove first label
          chart.data.datasets.forEach((dataset) => {
            dataset.data.shift(); // remove first data point
            dataset.pointBackgroundColor.shift();
            dataset.pointRadius.shift();
          });
        }

        chart.data.labels.push(time);
        chart.data.datasets.forEach((dataset) => {
          let ret = check_alerts(data[param], time); // 1 for threshold, 2 for anomaly, 0 for no alerts
          dataset.pointBackgroundColor = dataset.pointBackgroundColor || [];
          dataset.pointRadius = dataset.pointRadius || [];

          if (ret == 1) {
            dataset.pointBackgroundColor.push('red');
            dataset.pointRadius.push(3);
            dataset.data.push(data[param]);
          } else if (ret == 2) {
            dataset.pointBackgroundColor.push('blue');
            dataset.pointRadius.push(4);
            dataset.data.push(data[param]);
          } else {
            dataset.pointBackgroundColor.push('green');
            dataset.pointRadius.push(1);
            dataset.data.push(data[param]);
          }
        });

        // Update the chart label
        chart.data.datasets[0].label = 'Time vs ' + param;

        chart.update();
      }
    });
  } else {
    console.log('Machine or shift not selected.');
  }
}

function resetChart() {
  $.getJSON('/reset');
  chart.destroy();
  chart = new Chart(document.getElementById('oeeChart'), {
    type: 'line',
    data: {
      labels: [],  // Initially, the chart has no data
      datasets: [{
        label: 'Time vs Parameter',
        data: [],
        fill: false,
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
      }]
    },
    options: {
      scales: {
        x: {},
        y: {
          min: 0,
          max: 100,
        }
      }
    }
  });

  updateChart();
}


$.getJSON('/get_correlation_values', function(response) {
  console.log(response);  // logs: 12345
}).fail(function(error) {
  console.log(error);
});

// Update chart when dropdowns change
$('#machineSelect').change(resetChart);
$('#shiftSelect').change(resetChart);
$('#paramSelect').change(resetChart);

// Initial chart update
// updateChart();

setInterval(updateChart, 1000);  // Update the chart every second

$(document).ready(function() {
  // Fetch data and populate dropdowns when the page loads
  $.getJSON("/get_dropdown_data", function(data) {
    var dateSelect = $("#date-select");
    var machineSelect = $("#machine-select");
    var shiftSelect = $("#shift-select");
    var timeSelect = $("#time-select");
    var m = $("#machineSelect");
    var s = $("#shiftSelect");

    // Clear any existing options
    dateSelect.empty();
    machineSelect.empty();
    shiftSelect.empty();
    timeSelect.empty();

    // Populate the date dropdown
    data.dates.forEach(function(date) {
      dateSelect.append(new Option(date, date));
    });

    // Populate the machine dropdown
    data.machines.forEach(function(machine) {
      machineSelect.append(new Option(machine, machine));
      m.append(new Option(machine, machine));
    });

    // Populate the shift dropdown
    data.shifts.forEach(function(shift) {
      shiftSelect.append(new Option(shift, shift));
      s.append(new Option(shift, shift));
    });

    // Populate the time dropdown
    data.times.forEach(function(time) {
      timeSelect.append(new Option(time, time));
    });
  });
});

// Event handler for Manual Alerts button click
const manualAlertsButton = document.getElementById('manual-alerts-button');
const IncSubmitButton = document.getElementById('inc_submit');
const incidentDiv = document.getElementById('incident');

manualAlertsButton.addEventListener('click', function() {
  incidentDiv.style.display = 'block';
});

IncSubmitButton.addEventListener('click', function() {
  incidentDiv.style.display = 'none';
});

// Popup for Alert
document.getElementById('inc_submit').addEventListener('click', function(event) {
  event.preventDefault(); // Prevent form submission (for demonstration purposes)

  // Get form values
  var dateSelect = document.getElementById('date-select').value;
  var machineSelect = document.getElementById('machine-select').value;
  var shiftSelect = document.getElementById('shift-select').value;
  var timeSelect = document.getElementById('time-select').value;
  var incidentSelect = document.getElementById('incident-select').value;
  var descriptionText = document.getElementById('description-text').value;

  // Perform actions with the form values
  console.log('Form submitted!');
  console.log('Date: ' + dateSelect);
  console.log('Machine: ' + machineSelect);
  console.log('Shift: ' + shiftSelect);
  console.log('Time: ' + timeSelect);
  console.log('Incident: ' + incidentSelect);
  console.log('Description: ' + descriptionText);

  // Close the modal dialog
  $('#incidentModal').modal('hide');
});

function check_alerts(value, time) {
  // Check the condition for high-th
  if (value > an_high) {
    addNotification('Higher Anomaly', 'Anamalous Value ' + value + ' at ' + time + ' is high');
    return 2;
  }
  if (value < an_low) {
    addNotification('Lower Anomaly', 'Anamalous Value ' + value + ' at ' + time + ' is low');
    return 2;
  }

  if (value > $('#high').val()) {
    addNotification('Higher Threshold', 'Value ' + value + ' at ' + time + ' exceeds high threshold');
    return 1;
  }
  if (value < $('#low').val()) {
    addNotification('Lower Threshold', 'Value ' + value + ' at ' + time + ' is less than lower threshold');
    return 1;
  }

  return 0;
}

// Correlation Chart

const correlationChartCanvas = document.getElementById('correlationChart');

function generateCorrelationChart(data) {
  const labels = data.map(entry => `${entry.column1} - ${entry.column2} ${Math.round(entry.correlation * 100)}%`);
  const values = data.map(entry => Math.round(entry.correlation * 100)); // Convert the values to whole numbers

  const correlationChart = new Chart(correlationChartCanvas, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: '',
          data: values,
          backgroundColor: values.map(value => value < 0 ? 'rgba(255, 0, 0, 0.5)' : 'rgba(0, 128, 0, 0.5)'), // Grey for negative values, green for positive values
          borderColor: values.map(value => value < 0 ? 'rgba(255, 0, 0, 1)' : 'rgba(0, 128, 0, 1)'), // Grey for negative values, green for positive values
          borderWidth: 1,
        },
      ],
    },
    options: {
      indexAxis: 'y', // Display the chart horizontally
      responsive: true,
      scales: {
        x: {
          beginAtZero: true,
        },
      },
      plugins: {
      legend: {
        display: false, // Hide the legend
      },
    },
    },
  });
}

document.addEventListener('DOMContentLoaded', function() {
  const tab2Link = document.querySelector('a[href="#tab2"]');
  tab2Link.addEventListener('click', function() {
    // Fetch and display the correlation values
    fetch('/get_correlation_values')
      .then(response => response.json())
      .then(data => {
        generateCorrelationChart(data);
      })
      .catch(error => {
        console.error('Error fetching correlation values:', error);
      });
  });
});

// Tab 2

document.addEventListener('DOMContentLoaded', function() {
  const tab2Link = document.querySelector('a[href="#tab2"]');
  const connectForm = document.getElementById('connectForm');

  tab2Link.addEventListener('click', function(event) {
    event.preventDefault(); // Prevent the tab switch

    // Fetch and display the correlation values
    fetch('/get_correlation_values')
      .then(response => response.json())
      .then(data => {
        generateCorrelationChart(data);
      })
      .catch(error => {
        console.error('Error fetching correlation values:', error);
      });
  });

  connectForm.addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent form submission
    // Handle the connect button click event here
    // Add your code to connect to the desired functionality
    // For example, initiate a connection or perform an action
  });
});

// Trend Analysis
document.getElementById('trendForm').addEventListener('submit', function(event) {
  event.preventDefault(); // Prevent the form from submitting normally

  // Get the form data
  var formData = new FormData(this);

  // Send a POST request to the server
  fetch('/trend_check', {
    method: 'POST',
    body: formData
  })
    .then(response => response.text())
    .then(data => {
      // Update the resultTable element with the result
      document.getElementById('resultTable').innerHTML = data;
    })
    .catch(error => {
      console.error('Error:', error);
    });
});



//TAB --- 4

// Fetch data and populate dropdowns when the page loads
$.getJSON("/get_dropdown_data", function(data) {
  var machineSelectTab4 = $("#machineSelectTab4");
  var shiftSelectTab4 = $("#shiftSelectTab4");
  var paramSelectTab4 = $("#paramSelectTab4");

  // Clear any existing options
  machineSelectTab4.empty();
  shiftSelectTab4.empty();
  paramSelectTab4.empty();

  // Populate the machine dropdown
  data.machines.forEach(function(machine) {
    machineSelectTab4.append(new Option(machine, machine));
  });

  // Populate the shift dropdown
  data.shifts.forEach(function(shift) {
    shiftSelectTab4.append(new Option(shift, shift));
  });

  // Populate the parameter dropdown
  // Modify the following section to update the parameter dropdown based on your needs
  var allowedParameters = ["oee", "availability", "performance", "quality"];
  allowedParameters.forEach(function(parameter) {
    paramSelectTab4.append(new Option(parameter, parameter));
  });
});


// Forecasting
$('#tab4 form').submit(function(event) {
  event.preventDefault(); // Prevent the form from submitting normally

  // Get the selected values
  let machine = $('#machineSelectTab4').val();
  let shift = $('#shiftSelectTab4').val();
  let parameter = $('#paramSelectTab4').val();

  // Perform actions with the selected values
  console.log('Form submitted!');
  console.log('Machine: ' + machine);
  console.log('Shift: ' + shift);
  console.log('Parameter: ' + parameter);

  // Make a request to retrieve the forecasted data
  $.getJSON('/forecasting', {
    machine: machine,
    shift: shift,
    parameter: parameter,
    forecast_steps: 10  // Set a default value for forecast_steps
  }, function(data) {
    // Prepare the data for the chart
    if (Array.isArray(data.data)) {
      // Prepare the data for the chart
      let dates = [];
      let actualValues = [];
      let forecastedValues = [];

      data.data.forEach(function(item) {
        dates.push(item.Date);
        actualValues.push(item['Actual Values']);
        forecastedValues.push(item['Forecasted Values']);
      });

      // Create the chart using Chart.js
      let chartData = {
        labels: dates,
        datasets: [
          {
            label: 'Actual Values',
            data: actualValues,
            fill: false,
            borderColor: 'blue',
            tension: 0.1
          },
          {
            label: 'Forecasted Values',
            data: forecastedValues,
            fill: false,
            borderColor: 'grey',
            borderDash: [5, 5],
            tension: 0.1
          }
        ]
      };

      // Configure chart options
      let chartOptions = {
        scales: {
          x: {},
          y: {
            min: 0,
            max: 100
          }
        }
      };

      // Create or update the chart instance
      if (window.myChart) {
        // Update existing chart
        window.myChart.data = chartData;
        window.myChart.options = chartOptions;
        window.myChart.update();
      } else {
        // Create new chart
        let ctx = document.getElementById('forecasting').getContext('2d');
        window.myChart = new Chart(ctx, {
          type: 'line',
          data: chartData,
          options: chartOptions
        });
      }
    } else {
      console.log('Invalid data format:', data);
    }
  });
});
</script>
      <!-- Bootstrap Javascript -->
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
   </body>
</html>